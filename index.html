<!DOCTYPE html>
<html lang="en">
<script src='https://d3js.org/d3.v5.min.js'></script>
<head>
    <meta charset="UTF-8">
    <title>CS416-Narrative Visualization-SS</title>
</head>
<style>
    #tooltip {
        opacity: 0;
        position: absolute;
        text-align: center;
        background: lightblue;
        border: solid;
        border-width: 1px;
        border-radius: 2.5px;
        padding: 5px;
    }
    #annotation {
        position: absolute;
        text-align: center;
        max-width: 100px;
        font-size: 12px;
    }
    ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    li {
        float: left;
    }
    li a {
        display: block;
        padding: 8px;
        background-color: #dddddd;
    }
</style>
<body onload="init()">
<h1>California "A Small Business Paradise"</h1>
<svg width="900" height="500"></svg>
<div id="tooltip"></div>
<div id="annotation"></div>
<ul>
    <li><a href="scene-2.html">Next</a></li>
</ul>
</body>

<script type="text/javascript">

    async function init() {
        var data = await d3.csv("https://saurabh68.github.io/overview-full-data-min.csv");
        var states = ["CA", "MA", "VA", "MD", "NY", "CO", "TX", "OH", "PA", "NJ"];
        var colors = d3.scaleOrdinal().domain(states).range(d3.schemeCategory10);

        var scene1_data = d3.nest()
            .key(function (d) {
                return d.state;
            })
            //.sortKeys(d3.ascending)
            .rollup(function (leaves) {
                return {
                    "count": leaves.length
                    , "amount": d3.sum(leaves, function (d) {
                        return parseFloat(d.amount);
                    })
                }
            })
            .entries(data);

        var formatComma = d3.format(",");
        var formatMoney = function (d) {
            return "$" + d3.format(",.2f")(d);
        };

        var svg = d3.select("svg"),
            margin = {top: 20, right: 20, bottom: 50, left: 60},
            width = +svg.attr("width") - margin.left - margin.right,
            height = +svg.attr("height") - margin.top - margin.bottom;
        var tooltip = d3.select("#tooltip");

        //x-scale
        var x = d3.scaleBand()
            .domain(scene1_data.map(function (d) {
                return d.key;
            }))
            .rangeRound([0, width])
            .padding(0.1);

        //y-scale
        var y = d3.scaleLinear()
            .domain([0, d3.max(scene1_data, function (d) {
                return d.value.count;
            })])
            .rangeRound([height, 0]);

        //bar-chart
        d3.select("svg").append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .selectAll()
            .data(scene1_data)
            .enter().append("rect")
            .attr("fill", function (d) {
                return colors(d.key)
            })
            .attr("x", function (d) {
                return x(d.key);
            })
            .attr("y", function (d) {
                return y(d.value.count);
            })
            .attr("width", x.bandwidth())
            .attr("height", function (d) {
                return height - y(d.value.count);
            })
            .attr("id", function (d) {
                return d.key;
            })
            .on("mouseover", function (d) {
                tooltip.style("opacity", 0.8)
                    .style("left", (+d3.select(this).attr("x") + margin.left) + "px")
                    .style("top", (+d3.select(this).attr("y") + margin.top + 30) + "px")
                    .html("#Awards: " + formatComma(d.value.count) + "<br> Amount: " + formatMoney(d.value.amount));
                d3.select(this).style("stroke", "black");
            })
            .on("mouseout", function () {
                tooltip.style("opacity", 0);
                d3.select(this).style("stroke", "none");
            });

        //y-axis
        d3.select("svg").append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .call(d3.axisLeft(y).tickFormat(d3.format(".1s")))
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("x", -(height / 2))
            .attr("y", -(margin.left - 20))
            .style("text-anchor", "middle")
            .style("fill", "black")
            .style("font-size", "15px")
            .text("No. of Awards");

        //x-axis
        d3.select("svg").append("g")
            .attr("transform", "translate(" + margin.left + "," + (height + margin.top) + ")")
            .call(d3.axisBottom(x))
            .append("text")
            .attr("x", width / 2)
            .attr("y", margin.bottom - 10)
            .style("text-anchor", "middle")
            .style("fill", "black")
            .style("font-size", "15px")
            .text("States");

        //annotations
        //triangle
        ca = d3.select("#CA");
        var triangle_x = +ca.attr("x") + +ca.attr("width") + 5 + margin.left;
        var triangle_y = ((height - +ca.attr("y")) / 3) + margin.top;
        var triangle = d3.symbol().type(d3.symbolTriangle).size(50);
        d3.select("svg")
            .append("g")
            .attr("transform", "translate(" + triangle_x + "," + triangle_y + ")")
            .append("path")
            .attr("d", triangle)
            .attr("fill", "black")
            .attr("transform", "rotate(-90)");
        //line
        d3.select("svg")
            .append("line")
            .style("stroke", "black")
            .style("stroke-width", 1)
            .attr("x1", triangle_x)
            .attr("y1", triangle_y)
            .attr("x2", triangle_x + 50)
            .attr("y2", triangle_y);
        //text
        d3.select("svg")
            .append("text")
            .attr("x", triangle_x + 50)
            .attr("y", triangle_y + 5)
            .style("fill", "black")
            .style("font-size", "15px")
            .text("Highest number of awards overall");
    }

</script>
</html>