<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <title>CS416-Narrative Visualization-SS</title>
</head>
<style>
    #tooltip {
        opacity: 0;
        position: absolute;
        text-align: center;
        background: lightblue;
        border: solid;
        border-width: 1px;
        border-radius: 2.5px;
        padding: 5px;
    }

    ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    li {
        float: left;
    }

    li a {
        display: block;
        padding: 8px;
        background-color: #dddddd;
    }

</style>
<body onload="init()">
<h1>California "A Small Business Paradise"</h1>
<h2>Socially & Economically Disadvantaged Small Businesses</h2>
<svg width="900" height="500"></svg>
<div id="tooltip"></div>
<ul>
    <li><a href="index.html">Previous</a></li>
    <li><a href="scene-3.html">Next</a></li>
</ul>
</body>

<script type="text/javascript">

    async function init() {
        var data = await d3.csv("https://saurabh68.github.io/overview-full-data-min.csv");
        var states = ["CA", "MA", "VA", "MD", "NY", "CO", "TX", "OH", "PA", "NJ"];
        var colors = d3.scaleOrdinal().domain(states).range(d3.schemeCategory10);
        //console.log(data[0]);

        //data for scene 2
        var scene2_data = d3.nest()
            .key(function (d) {
                return d.state;
            }).sortKeys(d3.ascending)
            .key(function (d) {
                return d.year
            }).sortKeys(d3.ascending)
            .rollup(function (leaves) {
                return {
                    "count": leaves.length
                    , "amount": d3.sum(leaves, function (d) {
                        return parseFloat(d.amount);
                    })
                }
            })
            .entries(data.filter(function (d) {
                return "Y" === d.socially_and_economically_disadvantaged
            }));
        var counts = [];
        var years = [];
        scene2_data.forEach(function (v1, i1, a1) {
            v1.values.forEach(function (v2, i2, a2) {
                counts.push(v2.value.count);
                years.push(+v2.key);
            })
        })
        //console.log(counts);
        //console.log(scene2_data[0]);

        var formatComma = d3.format(",");
        var formatMoney = function (d) {
            return "$" + d3.format(",.2f")(d);
        };

        var svg = d3.select("svg"),
            margin = {top: 20, right: 20, bottom: 50, left: 60},
            width = +svg.attr("width") - margin.left - margin.right,
            height = +svg.attr("height") - margin.top - margin.bottom;
        var tooltip = d3.select("#tooltip");

        //x-scale
        var x = d3.scaleLinear().domain([d3.min(years), d3.max(years)])
            .range([0, width]);

        //y-scale
        var y = d3.scaleLinear().domain([d3.min(counts), d3.max(counts)])
            .range([height, 0]);

        //x-axis
        d3.select("svg").append("g")
            .attr("transform", "translate(" + margin.left + "," + (height + margin.top) + ")")
            .call(d3.axisBottom(x).tickFormat(d3.format("d")))
            .append("text")
            .attr("x", width / 2)
            .attr("y", margin.bottom - 10)
            .style("text-anchor", "middle")
            .style("fill", "black")
            .style("font-size", "15px")
            .text("Years");

        //y-axis
        d3.select("svg").append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .call(d3.axisLeft(y)) //.tickFormat(d3.format(".1s"))
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("x", -(height / 2))
            .attr("y", -(margin.left - 20))
            .style("text-anchor", "middle")
            .style("fill", "black")
            .style("font-size", "15px")
            .text("No. of Awards");

        //line function
        var lineGenerator = d3.line().x(function (d) {
                return x(+d.key)
            })
                .y(function (d) {
                    return y(d.value.count)
                })
        ;

        scene2_data.forEach(function (v) {
            var state = v.key;
            var line_data = v.values;
            //console.log(line_data);
            var svg = d3.select("svg").append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            //path
            svg.append("path")
                .attr("id", state)
                .attr("d", lineGenerator(line_data))
                .attr("stroke", colors(state))
                .attr("stroke-width", 2)
                .attr("fill", "none");
            var path = d3.select("#" + state);
            const pathLength = path.node().getTotalLength();
            path.attr("stroke-dashoffset", pathLength)
                .attr("stroke-dasharray", pathLength)
                .transition(d3.transition().ease(d3.easeSin).duration(2500))
                .attr("stroke-dashoffset", 0);

            //dots
            var radius = 5;
            var hover_radius = 6;
            svg.selectAll().data(line_data)
                .enter().append("circle")
                .attr("id", function (d) {
                    return state + "-" + d.key
                })
                .attr("cx", function (d) {
                    return x(+d.key)
                })
                .attr("cy", function (d) {
                    return y(d.value.count)
                })
                .attr("r", radius)
                .attr("fill", colors(state))
                .on("mouseover", function (d) {
                    tooltip.style("opacity", 0.8)
                        .style("left", +d3.event.pageX + "px")
                        .style("top", +d3.event.pageY + "px")
                        .html(state + "(" + d.key + ")" + "<br>#Awards: " + formatComma(d.value.count) + "<br> Amount: " + formatMoney(d.value.amount));
                    d3.select(this).attr("r", hover_radius);
                })
                .on("mouseout", function () {
                    tooltip.style("opacity", 0);
                    d3.select(this).attr("r", radius);
                });

        });

        //annotations
        const type = d3.annotationCustomType(
            d3.annotationXYThreshold, {
                "className": "custom",
                "connector": {"end": "arrow"},
                "note": {"lineType": "horizontal"}
            })
        var connectorX1 = d3.select("#CA-2011").attr("cx");
        var connectorY1 = d3.select("#CA-2011").attr("cy");
        var subjectX1 = d3.select("#CA-2004").attr("cx");
        var subjectX2 = d3.select("#CA-2019").attr("cx");
        const annotations = [{
            note: {
                label: "Socially & Economically Disadvantaged companies in California has received most " +
                    "no of awards since 2004."
            },
            x: connectorX1 - 20,
            y: connectorY1 - 20,
            dy: -25,
            dx: 50,
            subject: {
                x1: subjectX1,
                x2: subjectX2
            }

        }];
        const makeAnnotations = d3.annotation().textWrap(250).type(type).annotations(annotations);
        d3.select("svg").append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .attr("class", "annotation-group").call(makeAnnotations);

    }

</script>
</html>